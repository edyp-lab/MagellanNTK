---
title: "MagellanNTK user manual"
author: 
- name: Samuel Wieczorek
- name: Thomas Burger
package: MagellanNTK
abstract: >
    The R package `MagellanNTK` (Magellan Navigation ToolKit) is a workflow 
    manager using Shiny modules. As it provides core engine 
    functionnality, it is a perfect companion package to make easier
    the succession of process of calculation for datasets.
    It has been developed with genericity in mind so as to handle generic 
    data formats based of `list`.
date: "`r Sys.Date()`"
output:
    BiocStyle::html_document:
      toc: true
      highlight: tango
      number_sections: yes
      toc_depth: 2
      theme: united
      keep_md: true
      papersize: a4
vignette: >
    %\VignetteIndexEntry{MagellanNTK user Manual}
    %%\VignetteKeywords{Softmware, Mass Spectrometry, Quantitative, process manager}
    %\VignetteEncoding{UTF-8}
    %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  markdown: 
    wrap: 72
---

# Introduction

The package \`MagellanNTK\` provides the infrastructure for the
configuration, the execution and the surveillance of a defined sequence
of tasks. The tasks it uses are structured as Shiny modules. It is very
flexible in two ways:

-   It does not content any tasks to run but is only the infrastructure
    to manage them. Task have to be be inserted from another packages or
    code. Thus, \`MagellanNTK\` can work with a very large panel of
    domains. For more details on creating tasks for MagellanNTK, please
    see xxxx.

As for Shiny module, MagellanNTK can be run standalone or embebbed in
another Shiny module, as it is the case with the package [Prostar
2.0](https://github.com/prostarproteomics/Prostar.2.0) for example. In
order to have a more complete view of how MagellanNTK works or if you
intent to develop workflows or pipelines for MagellanNTK, it is advised
to see the xxx.

Generally, end users will not have to know much about `MagellanNTK`
other than the use of UI. This is the topic of this vignette. This is
why there is no installation nor technical section in his document.

To go further in technical details, please refer to:

-   'Configure MagellanNTK'

-   Build a pipeline module

-   Create a new pipeline tutorial

-   Create complex workflow

-   Inside MagellanNTK

This document starts with a general overview of workflows and their
principles. Then , it focuses ont the User Interface of
\``MagellanNTK`\`.

# Workflow overview

As a workflow manager, the aim of `MagellanNTK` is to execute a series
of ordered tasks over a dataset (see Fig \@ref(fig:WFprinciple)). The
workflow, instantiated by MagellanNTK, has two communication channels
(input and output). An input dataset is passed to the engine which
returns a new dataset (i.e. a dataset in which the result of tasks as
been added).

```{r 'WFprinciple', results='markup', fig.cap="A process: task organizer", echo=FALSE, out.width='100%', fig.align='center', fig.wide = TRUE}
knitr::include_graphics("./figs/WF_principle.png", error = FALSE)
```

## Single task

In MagellanNTK, a task (or step) is defined as a data analysis process
that performs a minimal and consistent set of operations on a dataset.
Note that the dataset is not obligatory modified, for example in case of
a visualization task. Each task has its own user interface, based on
Shiny modules. These interfaces may contain different elements to
interact with the user (widgets to define parameters values, plots,
etc).

In a workflow, the sequence of tasks is always one-way: it begins at the
first task and ends up at the last one. So, the simplest workflow is the
one where each task is executed after its previous one, from the first
one to the last one. However, it may be interesting to introduce some
additional rules to customize the sequence of tasks. Fro example, a
given task may be facultative (eventually under some condition) while
another one will be mandatory. The implementation of such possibilities
is made by mean of properties on tasks. Actually, one property refines
the possibilities of a task:

| Name      | Values       | Description                                                                   |
|---------------|---------------|-------------------------------------------|
| Mandatory | true / false | Indicates whether a task must be executed to be able to pursiue the workflow. |

: In order to decide what to do for the next task, MagellanNTK uses tags
on tasks to determine their state during the workflow:

| Tag     | Values       | Description                                                                                                                         |
|-----------|------------|-----------------------------------------------|
| Done    | true / false | Indicates whether a task has been executed                                                                                          |
| Skipped | true / false | Indicates whether a task has been skipped (i.e. it is not validated and there is at least one task further that has been validated) |
| Enabled | true / false | Indicates whether the UI of the task can be modified.                                                                               |

Concretely, tasks are identified by a combination of tags and
properties. Different styles are used to identify them in the user
interface (See Tab xxx)

|                              Bullet                              |   Property    |  State   | Done/Undone |
|:-------:|:-----------:|:---------:|:------------:|
| ![](figs/bullet_empty_red_disabled.png){width="15" height="15"}  |    Skipped    | Disabled |   Undone    |
| ![](figs/bullet_empty_red_disabled.png){width="15" height="15"}  |   Mandatory   | Disabled |   Undone    |
|        ![](figs/bullet_empty_red_enabled.png){width="15"}        |   Mandatory   | Enabled  |   Undone    |
| ![](figs/bullet_full_green_disabled.png){width="15" height="15"} |      \-       | Disabled |    Done     |
| ![](figs/bullet_empty_red_disabled.png){width="15" height="15"}  | Not mandatory |          |   Undone    |

## Process

In MagellanNTK, a process if defined as a sequence of tasks. Thus, it is
a more complex workflow than a single task (which is a workflow with
only one task). Processes are implemented as Shiny modules which contain
the user interface, the plots, the data analysis functions. This code is
not the purpose of MagellanNTK. For more details on how to build a
process module, see xxx.

```{r 'processOverview', results='markup', fig.cap="Process overview", echo=FALSE, out.width='100%', fig.align='center', fig.wide = TRUE}
knitr::include_graphics("./figs/process.png", error = FALSE)
```

Any process takes a dataset as input and returns a dataset as output.
The output dataset may be:

-   identical to the input dataset in the process do not modify it
    (vizualization functions for example),

-   different if the program modifies the data. In this case,
    MagellanNTK adds the modify dataset to the list of datasets rather
    than just updating the dataset. It means that if the list input has
    *n* datasets then the list at output will have *n+1* datasets .
    Thus, at any time, the list of datasets keeps the entire history of
    what happened to datasets.

## Pipeline

The engine's architecture in `MagellanNTK` is implemented in a recursive
way. A process has been defnied as a sequence of tasks. Here, one
defines a pipeline as a sequence of processes. Thus, if one remark that
a process can be view as a (complex) task, then a pipeline is also a
workflow. Thus, the manner of pipeline works will be very similar to a
process behaviour:

-   each process (complex tasks) in a pipeline has tags and properties
    (See xxx)

-   there is a list of datasets in input and get a list of datasets at
    output

As shown in xxx, a pipeline is at third level of such a structure.

```{r 'hierarchyWorkflow', results='markup', fig.cap="Process overview", echo=FALSE, out.width='100%', fig.align='center', fig.wide = TRUE}
knitr::include_graphics("./figs/pipeline.png", error = FALSE)
```

## Data formats

It has been descibed earlier that a single process uses a dataset as
input to execute some tasks and returns a (eventually) modified dataset.
In a whole workflow management system, this option has a caveat: if one
wants to save the resulting datasets all over the workflow, one must
implement this feature outside.

This feature is implemented in MagellanNTK as ordered list of datasets.
Rather than working a on a single dataset as input to a workflow,
MagellanNTK pass a list where each item is a dataset resulting of a
process. And each process takes the last dataset of this list to work on
it and its resulting new dataset is appended to the list.

The obly exception to that rule is the first dataset of the list which
is the original. s at a time but with an ordered list of datasets where
each datasets is the result of one process (except for the first dataset
which is the original one).

## Rules

Rules are applied here to guarantee that the global strategy of the
workflow in MagellanNTK are followed. This point is important to
understand the possibilities of navigation within the UI.

**Start workflow at the beginning**. When launching a workflow, the
first task is the only enabled task. This guarantees to always start
from the first one.

**One way direction**. The deroulement is in one way. Tasks are executed
from the first towards the last. It is not possible de go back or rerun
a task that has already been validated (exception if reset, see xxx).

**Tasks run once.** In the same way, once a task has been validated, it
becomes disabled. This is to avoid to rerun a task. In this case, that
would mean that a task could modify its own result (modify the dataset
it has already produced). This case is not possible in MagellanNTK

**Validating a task.** When a task is validated, all the further tasks
until the next mandatory one are automatically enabled.

**Disabled tasks**. A disabled task means there is a rule which do not
allow it to be executed at this time.

Those UI are developed by the creator of the process w.r.t. some
guidelines (See xxx). In particular, each step has of 'Validate' button
which save the dataset in the state it is at that time. Once the steps
has been validated, it status pass from 'Undone' to 'Done. Graphically,
this is visible with the bullet which become full rather than empty.

# User interface

The user interface provided by MagellanNTK allows to work with processes
and pipelines. as it is said previously, a pipeline is nothing than a
more complex process. Thus, the basic organisation of the interfaces for
processes and pipelines are very similar and share a lot of features.

For this reason, this section mainly focuses on a process workflow to
explain how it works. Describing more complex structures will be easier.

## UI layout

For this section, one consider the following example: a process called
'Process 1' which contains 4 steps called respectively 'Description',
'Step1', 'Step2,' and 'Save'. The first and last steps are inserted by
MagellanNTK and are common to every workflow while the steps 'Step1' and
'Step2' are specific to the workflow. The UI for this process is showed
in Fig \@ref(fig:UIprocess).

```{r 'UIprocess', results='markup', fig.cap="UI process", echo=FALSE, out.width='100%', fig.align='center', fig.wide = TRUE}
knitr::include_graphics("./figs/UI_process.png", error = FALSE)
```

-   the area called **Timeline** represent the actions defined in the
    process, placed in the order they might be executed. It is the
    representation of the set of steps composing the process

-   The area called **Navigation commands** contains the navigation
    buttons ('Next, 'Previous' and 'Reset') that allow to pass from a
    step to another one (changing the current step)

-   the region **Main UI** is the place where the content of each step
    of the workflow is displayed.

This place shows the content of the current step. Depending on which
actions are allowed at current time, the widgets used to interact with
the interface may be enabled or disabled. This depends of the state of
the process and is explained in details in section xxx.

The state of the bullet in the timeline for a given step determines the
state of the widgets in the corresponding UI. It means that if the
bullet of a step is enabled then all the widgets of this step are
enabled (the Perform button also). In the contrary, a bullet that is
disabled means that all the widgets and the 'Perform' button in the UI
are disabled

## Timeline

In this schema, the steps are represented by bullets linked by lines. At
any time, the current step is marked with an underline below the name of
the step.

The style of bullets varies w.r.t. some conditions. The table below
describes the possible styles. There are explained in more details in
the section xxx

In the timelines, steps are identified by bullets linked by line. The
style of both bullets and line gives an information about the state of
the corresponding step.

## Navigation commands

Three buttons are available to interact with the whole current step and
navigate through the different steps of the process.

The **Prev** button (on the left) changes the current step to set the
previous one. This button is enabled only if there is at least one step
backward.

Similarly, the **Next** button (on the right) changes the current step
to set the next one on the timeline. This button is enabled only if
there is at least one step forwards.

The **Reset** button sets all the widgets of the process to their
default value. It is enabled only if the process is not validated yet.
The current step is also set to the first one.

The behaviour of the timeline used in the general workflow is similar in
many points to the data processing modules

The 'Next' and 'Previous' buttons can be enabled or disabled w.r.t the
current position. They are enabled if it is possible to go in their
direction

Note that the 'Reset' button is always enabled.

## Rules

A step at rank *n* is enabled if:

-   the previous step (*n-1*) is validated

-   or if another previous (*\<n-1*) step is validated and there is no
    mandatory and undone steps between them. This ensure that the
    mandatory step will be validated

It is always possible to navigate between all the steps event if they
are disabled. This feature is useful if one wants to see/discover the
content of next steps or to remind the values set in the previous
widgets.

## Interface for processes

The interface for each step contains at least one button named
'Perform'. This is the mean to validate a step. Th evalidatin of a step
leads to different actions in the UI, especially a change in the status
of bullets and other steps.

-   A process cannot be run several times on the same dataset. To avoid
    that, a process be run on the previous result of itself.

## Interface for pipelines

In the case of a pipeline, a second pipeline is needed to navigate
between processes. Thus, in Fig \@ref(fig:UIpipelineannotated), is
figured the UI of a pipeline with the additional timeline.

```{r 'UIpipelineannotated', results='markup', fig.cap="UI process", echo=FALSE, out.width='100%', fig.align='center', fig.wide = TRUE}
knitr::include_graphics("./figs/UI_pipeline_annotated.png", error = FALSE)
```

Note that in a pipeline timeline, the first step is still 'Description'
but there is not more step called 'Save' as it is the case for any
process timeline. The reason is because it is not necessary due to the
fact that a 'Save' step exists in the last process.

Thus, when the user save its work in the last process of the pipeline,
this will automatically save the whole object and return it to the
caller program.

# Process workflow

This section aims at describing how to use the workflow UI when
processing a dataset. The goal is not to describe the different data
processing tools available but to explain the behaviour of the user
interface of what we call 'MagellanNTK core'. One focus here on the
level of processes. To remind, a process is composed in steps which are
direct actions (steps) on the dataset.

To run this use case while reading explanations, type the following
command in a R console:

``` r
library(MagellanNTK)
demo_workflow()
```

**Launching the workflow**

When the user launches the workflow manager, it comes with the first
Step called 'Description'. At this time, all the other steps are
disabled until the user validate the current step. This ensure that the
dataset is correctly passed to the first step. By default, a workflow
work on the last dataset of the object. Thus, if this object contains
several datasets, the last one is loaded.

```{r 'demo_1', results='markup', fig.cap="UI process", echo=FALSE, out.width='100%', fig.align='center', fig.wide = TRUE}
knitr::include_graphics("./figs/demo_1.png", error = FALSE)
```

At this step, only the 'Description' step is enabled (see the style of
the bullet and the button 'Start'). The other steps (timeline) are
disabled. However, it is possible to view the content of the other
steps.

```{r 'demo_1_2', results='markup', fig.cap="UI process", echo=FALSE, out.width='100%', fig.align='center', fig.wide = TRUE}
knitr::include_graphics("./figs/demo_1_2.png", error = FALSE)
```

**Validating the 'Description' step**

Here, the user has clicked on the 'Start' button (contented in the ui of
'Description' step). The bullet has changed to take the style of 'Done'
steps.

```{r 'demo_1_3', results='markup', fig.cap="UI process", echo=FALSE, out.width='100%', fig.align='center', fig.wide = TRUE}
knitr::include_graphics("./figs/demo_1_3.png", error = FALSE)
```

The validation of the step (same behavior for all steps) has two main
consequences:

-   The current step ( here 'Description') becomes disabled (all its
    widgets disabled). This is to avoid any additional action from the
    user inside this step

-   The forwarding steps may potentially be enabled but this must
    respect the rule (See xxx). In this case, the steps 'Step 1' and
    'Step 2' are enabled but not the step 'Save' because it is placed
    after a non-validated mandatory step.

The user switch to 'Step 1' by clicking on the 'Next' button.

The 'Step 1' is now the current step (note the underline that means it
is now the current step). As it is enabled, all its widgets are enabled.

```{r 'demo_2', results='markup', fig.cap="UI process", echo=FALSE, out.width='100%', fig.align='center', fig.wide = TRUE}
knitr::include_graphics("./figs/demo_2.png", error = FALSE)
```

In this use case, on gonna skip this step. For this, the user go to the
next step ('Step 2') by clicking on the 'Next' button.

The user set the widgets to the value he wants and then validate his
choices by clicking on the button 'Perform'. Once done, the entire step
become disabled and the bullet's style is changing to "Done".

```{r 'demo_3', results='markup', fig.cap="UI process", echo=FALSE, out.width='100%', fig.align='center', fig.wide = TRUE}
knitr::include_graphics("./figs/demo_3.png", error = FALSE)
```

One the widgets are set to their custom value, the user validate the
step by clicking on the 'Perform' button. The changes are:

-   As for all current steps, the entire interface switch to a disabled
    state,

-   the bullet changes to the style of Validated steps

-   the next steps become enabled. In this case, there is only one last
    step ('Save')

-   the style of bullets for previous steps is updated if necessary. It
    is the case for 'Step 1' which has been skipped

Note: A step is really skipped only if it has not been validated and a
further one is validated. That means that one can begin to modify the
widgets in a step *n*. If the user do not validate it and go to another
step (*\>n*), then the values of the step *n* will be forgotten.

If one go back to the previous step (the one we have skipped), we can
see a blue area which informs the user that this step has been skipped
(it has been disabled even with no validation).

```{r 'demo_3_3', results='markup', fig.cap="UI process", echo=FALSE, out.width='100%', fig.align='center', fig.wide = TRUE}
knitr::include_graphics("./figs/demo_3_3.png", error = FALSE)
```

**Saving workflow result**

The last step has been enabled by the validation of the previous step.
The user can now save its work by clicking on the 'Save' button. This
will result in sending th new dataset (processed by this workflow) to
the program which has called it.

```{r 'demo_4', results='markup', fig.cap="UI process", echo=FALSE, out.width='100%', fig.align='center', fig.wide = TRUE}
knitr::include_graphics("./figs/demo_4.png", error = FALSE)
```

To ensure consistency in workflow, each step has some properties which
are used to drive the workflow. Note that here, one look at a given
level and steps can be processes if we are at the level of pipeline.

the resulting new item is appended to the list of items.

To remind, the object get at this step has one more dataset than the one
given at the beginning.

A process cannot be run more than one time on the same item. To avoid
that a process be run on the previous result of itself.

**Reset a process**

The button 'Reset' allows to set back the workflow in its default state
(the same state as when the user launches the workflow). At any time, it
is possible to reset the workflow; A popup warns the user of the
effects.

```{r 'demo_reset', results='markup', fig.cap="UI process", echo=FALSE, out.width='100%', fig.align='center', fig.wide = TRUE}
knitr::include_graphics("./figs/demo_reset.png", error = FALSE)
```

Then, if the reset is done, one return to the initial state of the
workflow (see fig..)

About the dataset. Two different things appears whether the Reset button
is clicked:

-   **Reset is clicked after the user has validated the whole process**.
    That means that the object has one more dataset (the one that has
    been calculated during the process). In this case, a click on the
    Reset button delete the last dataset in the object so as to return
    to the same object as vefore.

-   **Reset is clicked whenever during the workflow (which is not
    validated yet)**. In a process workflow, there is no engine to save
    the object at each step of the workflow. That means that during the
    workflow, the initial object has no changes (changes are made in a
    temporary object). Thus, if a Reset occurs at this time, it happens
    nothing to the object.

# Pipeline workflow

**Launch a pipeline**

When laucnhing a pipeline workflow, two timelines appear (their style -
vertical or horizontal - depends of the parameters used). The upper one
is dedicated to the steps (each one is a process) of the pipeline while
the down one stands for the steps of the process.

Note that the process called 'Description' of a pipeline does not have
any steps besides a Description one. This is an exception to the rule
that any process have at least one real step.

![Again, while a mandatory step is not validated (here, the step
'Description' of the first process 'Description'), all of its further
steps is disabled.](figs/demo_pipeline_1.png)

![The Description step has been validated and the other processes have
been enabled. The object to analyze has been
loaded.](figs/demo_pipeline_1_3.png)

```{r 'demo_pipeline_5', results='markup', fig.cap="UI process", echo=FALSE, out.width='100%', fig.align='center', fig.wide = TRUE}
knitr::include_graphics("./figs/demo_pipeline_5.png", error = FALSE)
```

When using a pipeline level, there are two timelines and therefore, two
'Reset' Buttons: one for the pipeline itself and one for the processes

**Resetting a process**

If the Reset button of a process is clicked, that affects only the
current process. The behavior is the same as for processes (See xxx).
The current step becomes the first one (Description), all the widgets
are set to their default values and are disabled. The current process is
still the same

**Resetting a pipeline**

If the Reset button of a pipeline is clicked, this will set back the
entire pipeline to its default values. The object is set back to the
beginning, i.e. all the datasets added by the processes are deleted. In
the pipeline's timeline, the first sptep ('Description') becomes the
current one.

If the user goes backward on a previous step and validate this step,
then the following steps are automatically set to 'undone' and have to
be rerun. This guarantees that the steps are always done in the same
way. This feature must be implemented in each module source code. It
cannot be coded in the navigation module (recursive loop on the listener
of isDone vector)

# Reprocess a dataset

Suppose i = N and p = P (from the standard workflow). The user can
change the current item of the dataset (WHAT'S ITS GOAL ?????)

-   i \< N (the current item is not the last one of the dataset): Two
    cases has to be distinguished:
    -   p = P ((the current process is the last process of the
        workflow): xxx \* p \< P (the current process is not the last
        one of the workflow): xxx

In both cases, one delete all the items of the dataset from i+1 to N
then the new item (produced by the process) is appended to the dataset
list.

At the end of this sequence, the current indices must return to their
normal values (i = N, p = P). That means that the real workflow has been
modified by the user but the final workflow is like the standard one
\###

-   a l'affichage de l'UI d'un processus déjà exécuté auparavant:
-   si l'indice courant i est positionné sur le dernier élément du
    dataset, alors affichage du début du processus, \* si i est
    positionné sur un dataset précédent (i \< N) (le dataset déjà traité
    par ce processus), alors on n'affiche que la dernière page du
    processus

# Session information

```{r}
sessionInfo()
```

workflow
